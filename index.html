<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Parsel + POI Harita</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.121/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.121/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style> /* Aynƒ± stil ve ekran 1/2 yapƒ±sƒ± */ </style>
</head>
<body>
  <!-- Ekran 1: Dosya Y√ºkleme -->
  <div id="uploadContainer">‚Ä¶</div>

  <!-- Ekran 2: Harita -->
  <div id="cesiumContainer"></div>

  <script>
    // ‚Ä¶ √ñnceki init dosya y√ºkleme kƒ±smƒ± ‚Ä¶

    function initializeCesium(geojson) {
      Cesium.Ion.defaultAccessToken = '‚Ä¶';

      const viewer = new Cesium.Viewer('cesiumContainer', {
        terrainProvider: new Cesium.EllipsoidTerrainProvider(),
        timeline: false, animation: false
      });

      Cesium.GeoJsonDataSource.load(geojson, { fill, stroke‚Ä¶ }).then(ds => {
        viewer.dataSources.add(ds);
        const ent = ds.entities.values[0];
        const pos = ent.polygon.hierarchy.getValue(Cesium.JulianDate.now()).positions;
        const ctr = Cesium.BoundingSphere.fromPoints(pos).center;

        // Pin ve etiket ekleme burada‚Ä¶

        const cart = Cesium.Cartographic.fromCartesian(ctr);
        const lon = Cesium.Math.toDegrees(cart.longitude);
        const lat = Cesium.Math.toDegrees(cart.latitude);

        // ‚ûï POI ekle
        fetchPOIs(lon, lat).then(pois => {
          pois.forEach(poi => addPOI(viewer, poi));
        });

        // Kamera d√∂n√º≈ü√º, video kaydƒ±‚Ä¶
      });
    }

    // üìç Overpass API‚Äôden amenity veri √ßek
    async function fetchPOIs(lon, lat) {
      const radius = 500; // metre
      const query = `
[out:json][timeout:25];
(
  node
    ["amenity"~"cafe|restaurant|hospital|school|pharmacy|bank"]
    (around:${radius},${lat},${lon});
);
out center;
`;
      const res = await fetch('https://overpass-api.de/api/interpreter', {
        method: 'POST',
        body: "data=" + encodeURIComponent(query),
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
      });
      const json = await res.json();
      return json.elements || [];
    }

    function addPOI(viewer, poi) {
      const [lon, lat] = [poi.lon, poi.lat];
      const name = poi.tags.name || poi.tags.amenity;
      const icon = 'https://cdn-icons-png.flaticon.com/512/684/684908.png';
      const pos = Cesium.Cartesian3.fromDegrees(lon, lat, 20);

      viewer.entities.add({
        name,
        position: pos,
        billboard: { image: icon, width: 32, height: 32 },
        label: {
          text: name,
          font: '14pt sans-serif',
          verticalOrigin: Cesium.VerticalOrigin.TOP,
          pixelOffset: new Cesium.Cartesian2(0, -30),
          fillColor: Cesium.Color.WHITE,
          style: Cesium.LabelStyle.FILL_AND_OUTLINE,
          outlineColor: Cesium.Color.BLACK,
          outlineWidth: 2
        }
      });
    }
  </script>
</body>
</html>